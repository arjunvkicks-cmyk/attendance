<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Attendance System</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .card {
      background: #fff; border-radius: 12px;
      padding: 28px 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 340px; text-align: center;
    }
    h2 { color: #1a237e; margin-bottom: 20px; font-size: 1.3rem; }
    h3 { color: #444; margin-bottom: 14px; font-size: 1rem; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 10px 14px;
      border: 1px solid #ccc; border-radius: 8px;
      margin-bottom: 12px; font-size: 0.95rem;
    }
    input:focus { outline: none; border-color: #3f51b5; }
    #video {
      width: 100%; border-radius: 10px;
      background: #111; display: block;
      margin-bottom: 10px; min-height: 200px;
    }
    #photoPreview {
      width: 100%; border-radius: 10px;
      border: 2px solid #43a047;
      display: none; margin-bottom: 10px;
    }
    button {
      width: 100%; padding: 11px; border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer; margin-bottom: 10px;
      transition: opacity 0.2s; font-weight: 600;
    }
    button:hover    { opacity: 0.88; }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    #loginBtn    { background: #3f51b5; color: #fff; }
    #snapBtn     { background: #1a237e; color: #fff; }
    #retakeBtn   { background: #ef6c00; color: #fff; display: none; }
    #clockInBtn  { background: #43a047; color: #fff; }
    #clockOutBtn { background: #e53935; color: #fff; }
    #logoutBtn   { background: #757575; color: #fff; font-weight: 400; }
    #statusMsg   { margin-top: 6px; font-size: 0.88rem; color: #555; min-height: 20px; line-height: 1.4; }
    #infoBox {
      background: #e8f5e9; border-radius: 8px; padding: 8px 10px;
      font-size: 0.8rem; color: #2e7d32; margin-bottom: 10px; display: none;
    }
    #errorBox {
      background: #ffebee; border-radius: 8px; padding: 8px 10px;
      font-size: 0.8rem; color: #c62828; margin-bottom: 10px; display: none;
    }
  </style>
</head>
<body>
<div class="card">

  <!-- LOGIN -->
  <div id="loginDiv">
    <h2>ğŸ¢ Attendance System</h2>
    <input type="text"     id="loginId"  placeholder="Login ID"  autocomplete="username">
    <input type="password" id="password" placeholder="Password"  autocomplete="current-password"
      onkeydown="if(event.key==='Enter') login()">
    <button id="loginBtn" onclick="login()">Login</button>
    <div id="statusMsg"></div>
  </div>

  <!-- ATTENDANCE -->
  <div id="attendanceDiv" style="display:none;">
    <h2>ğŸ¢ Attendance System</h2>
    <h3 id="welcome"></h3>
    <div id="infoBox"></div>
    <div id="errorBox"></div>
    <video id="video" autoplay playsinline muted></video>
    <img   id="photoPreview" alt="Captured Photo">
    <button id="snapBtn"     onclick="snapPhoto()">ğŸ“¸ Photo Lo</button>
    <button id="retakeBtn"   onclick="retakePhoto()">ğŸ”„ Dobara Lo</button>
    <button id="clockInBtn"  onclick="clockIn()">âœ… Clock In</button>
    <button id="clockOutBtn" onclick="clockOut()">ğŸ”´ Clock Out</button>
    <button id="logoutBtn"   onclick="logout()">Logout</button>
    <div id="statusMsg"></div>
  </div>

</div>
<script>
  // â˜… Google Apps Script URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxz44L38utZ0rsvkunrGGirVrgKXDfrIKR7__A2M79obycmZ5szE1U3OiBuExDEs3Yk/exec";

  let currentUser  = "";
  let currentName  = "";
  let cameraStream = null;
  let photoBase64  = "";

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(msg) { document.getElementById("statusMsg").textContent = msg; }
  function showInfo(msg)  { const b = document.getElementById("infoBox");  b.textContent = msg; b.style.display = msg ? "block" : "none"; }
  function showError(msg) { const b = document.getElementById("errorBox"); b.textContent = msg; b.style.display = msg ? "block" : "none"; }
  function setBtns(flag) {
    ["loginBtn","clockInBtn","clockOutBtn","snapBtn"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = flag;
    });
  }

  // â”€â”€ API Call (fetch instead of google.script.run) â”€â”€
  function callScript(action, data, callback) {
    const params = Object.assign({ action: action }, data);
    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(params),
      headers: { "Content-Type": "text/plain" } // text/plain avoids CORS preflight
    })
    .then(r => r.json())
    .then(callback)
    .catch(function(err) {
      setBtns(false);
      setStatus("âŒ Network error: " + err.message);
    });
  }

  // â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function login() {
    const loginId  = document.getElementById("loginId").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!loginId || !password) { setStatus("âš ï¸ Login ID aur Password daalo."); return; }

    setStatus("Logging inâ€¦");
    setBtns(true);

    callScript("login", { loginId, password }, function(res) {
      setBtns(false);
      if (res.status) {
        currentUser = loginId;
        currentName = res.name;
        document.getElementById("loginDiv").style.display      = "none";
        document.getElementById("attendanceDiv").style.display = "block";
        document.getElementById("welcome").textContent = "Welcome, " + res.name + " ğŸ‘‹";
        setStatus("");
        startCamera();
      } else {
        setStatus("âŒ " + (res.message || "Invalid Login."));
      }
    });
  }

  // â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startCamera() {
    showError(""); showInfo("Camera shuru ho raha haiâ€¦");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
    .then(function(stream) {
      cameraStream = stream;
      const video = document.getElementById("video");
      video.srcObject = stream;
      video.style.display = "block";
      video.onloadedmetadata = function() {
        video.play();
        showInfo("âœ… Camera ready â€” ğŸ“¸ Photo Lo dabao.");
      };
    })
    .catch(function(err) {
      showError("âŒ Camera error: " + err.message + " â€” Browser address bar mein camera allow karo.");
      showInfo("");
    });
  }

  function stopCamera() {
    if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  }

  // â”€â”€ Snap / Retake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function snapPhoto() {
    const video = document.getElementById("video");
    if (!video.videoWidth) { setStatus("âš ï¸ Camera ready nahi, thoda wait karo."); return; }
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    photoBase64 = canvas.toDataURL("image/jpeg", 0.7);

    document.getElementById("photoPreview").src          = photoBase64;
    document.getElementById("photoPreview").style.display = "block";
    document.getElementById("video").style.display        = "none";
    document.getElementById("snapBtn").style.display      = "none";
    document.getElementById("retakeBtn").style.display    = "block";
    showInfo("âœ… Photo li gayi! Ab Clock In / Clock Out karo.");
    setStatus("");
  }

  function retakePhoto() {
    photoBase64 = "";
    document.getElementById("photoPreview").style.display = "none";
    document.getElementById("photoPreview").src           = "";
    document.getElementById("video").style.display        = "block";
    document.getElementById("snapBtn").style.display      = "block";
    document.getElementById("retakeBtn").style.display    = "none";
    showInfo("âœ… Camera ready â€” ğŸ“¸ Photo Lo dabao.");
    setStatus("");
  }

  // â”€â”€ Geolocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getLocation(callback) {
    if (!navigator.geolocation) { callback(null, null); return; }
    navigator.geolocation.getCurrentPosition(
      p  => callback(p.coords.latitude, p.coords.longitude),
      () => callback(null, null),
      { timeout: 10000 }
    );
  }

  // â”€â”€ Clock In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clockIn() {
    if (!photoBase64) { setStatus("âš ï¸ Pehle ğŸ“¸ Photo Lo button dabao."); return; }
    setStatus("ğŸ“ Location le raha hunâ€¦"); setBtns(true);
    getLocation(function(lat, lng) {
      setStatus("â³ Clock In ho raha haiâ€¦");
      callScript("clockIn", { loginId: currentUser, name: currentName, lat, lng, photo: photoBase64 }, function(res) {
        setBtns(false);
        setStatus(res.message && res.message.includes("Successful") ? "âœ… " + res.message : "âš ï¸ " + (res.message || res));
        if (res.message && res.message.includes("Successful")) retakePhoto();
      });
    });
  }

  // â”€â”€ Clock Out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clockOut() {
    if (!photoBase64) { setStatus("âš ï¸ Pehle ğŸ“¸ Photo Lo button dabao."); return; }
    setStatus("ğŸ“ Location le raha hunâ€¦"); setBtns(true);
    getLocation(function(lat, lng) {
      setStatus("â³ Clock Out ho raha haiâ€¦");
      callScript("clockOut", { loginId: currentUser, lat, lng, photo: photoBase64 }, function(res) {
        setBtns(false);
        setStatus(res.message && res.message.includes("Successful") ? "âœ… " + res.message : "âš ï¸ " + (res.message || res));
        if (res.message && res.message.includes("Successful")) retakePhoto();
      });
    });
  }

  // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function logout() {
    stopCamera(); retakePhoto();
    currentUser = currentName = "";
    document.getElementById("loginId").value  = "";
    document.getElementById("password").value = "";
    document.getElementById("attendanceDiv").style.display = "none";
    document.getElementById("loginDiv").style.display      = "block";
    showInfo(""); showError(""); setStatus("");
  }
</script>
</body>
</html>
