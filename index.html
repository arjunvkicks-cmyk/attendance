<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vault Kicks Attendance</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .card {
      background: #fff; border-radius: 12px;
      padding: 28px 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 340px; text-align: center;
    }
    h2 { color: #1a237e; margin-bottom: 20px; font-size: 1.3rem; }
    h3 { color: #444; margin-bottom: 14px; font-size: 1rem; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 10px 14px;
      border: 1px solid #ccc; border-radius: 8px;
      margin-bottom: 12px; font-size: 0.95rem;
    }
    input:focus { outline: none; border-color: #3f51b5; }
    #video {
      width: 100%; border-radius: 10px;
      background: #111; display: block;
      margin-bottom: 10px; min-height: 200px;
    }
    #photoPreview {
      width: 100%; border-radius: 10px;
      border: 2px solid #43a047;
      display: none; margin-bottom: 10px;
    }
    button {
      width: 100%; padding: 11px; border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer; margin-bottom: 10px;
      transition: opacity 0.2s; font-weight: 600;
    }
    button:hover    { opacity: 0.88; }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    #loginBtn    { background: #3f51b5; color: #fff; }
    #snapBtn     { background: #1a237e; color: #fff; }
    #retakeBtn   { background: #ef6c00; color: #fff; display: none; }
    #clockInBtn  { background: #43a047; color: #fff; }
    #clockOutBtn { background: #e53935; color: #fff; }
    #weekOffBtn  { background: #7b1fa2; color: #fff; }
    #leaveBtn    { background: #f57c00; color: #fff; }
    #logoutBtn   { background: #757575; color: #fff; font-weight: 400; }
    #compOffBtn  { background: #00897b; color: #fff; }
    #statusMsg   { margin-top: 6px; font-size: 0.88rem; color: #555; min-height: 20px; line-height: 1.4; }
    #infoBox {
      background: #e8f5e9; border-radius: 8px; padding: 8px 10px;
      font-size: 0.8rem; color: #2e7d32; margin-bottom: 10px; display: none;
    }
    #errorBox {
      background: #ffebee; border-radius: 8px; padding: 8px 10px;
      font-size: 0.8rem; color: #c62828; margin-bottom: 10px; display: none;
    }
    .divider { border: none; border-top: 1px solid #eee; margin: 4px 0 10px 0; }

    /* â”€â”€ SUCCESS POPUP â”€â”€ */
    #popupOverlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      justify-content: center; align-items: center;
    }
    #popupOverlay.show { display: flex; }
    #popupBox {
      background: #fff; border-radius: 16px;
      padding: 32px 28px; text-align: center;
      width: 290px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0.7); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    #popupIcon  { font-size: 3rem; margin-bottom: 10px; }
    #popupTitle { font-size: 1.2rem; font-weight: 700; color: #1a237e; margin-bottom: 8px; }
    #popupMsg   { font-size: 0.95rem; color: #444; margin-bottom: 20px; line-height: 1.5; }
    #popupBtn   {
      background: #1a237e; color: #fff;
      border: none; border-radius: 8px;
      padding: 10px 32px; font-size: 1rem;
      cursor: pointer; font-weight: 600;
    }
    #popupBtn:hover { opacity: 0.88; }
  </style>
</head>
<body>

<!-- â”€â”€ SUCCESS POPUP â”€â”€ -->
<div id="popupOverlay">
  <div id="popupBox">
    <div id="popupIcon">âœ…</div>
    <div id="popupTitle">Success!</div>
    <div id="popupMsg"></div>
    <button id="popupBtn" onclick="closePopup()">OK</button>
  </div>
</div>

<div class="card">

  <!-- LOGIN -->
  <div id="loginDiv">
    <h2>ğŸ¢ Attendance System</h2>
    <input type="text"     id="loginId"  placeholder="Login ID"  autocomplete="username">
    <input type="password" id="password" placeholder="Password"  autocomplete="current-password"
      onkeydown="if(event.key==='Enter') login()">
    <button id="loginBtn" onclick="login()">Login</button>
    <div id="statusMsg"></div>
  </div>

  <!-- ATTENDANCE -->
  <div id="attendanceDiv" style="display:none;">
    <h2>ğŸ¢ Attendance System</h2>
    <h3 id="welcome"></h3>
    <div id="infoBox"></div>
    <div id="errorBox"></div>
    <video id="video" autoplay playsinline muted></video>
    <img   id="photoPreview" alt="Captured Photo">
    <button id="snapBtn"     onclick="snapPhoto()">ğŸ“¸ Take Photo</button>
    <button id="retakeBtn"   onclick="retakePhoto()">ğŸ”„ Retake Photo</button>
    <button id="clockInBtn"  onclick="clockIn()">âœ… Clock In</button>
    <button id="clockOutBtn" onclick="clockOut()">ğŸ”´ Clock Out</button>
    <hr class="divider">
    <button id="weekOffBtn" onclick="markWeekOff()">ğŸ“… Week Off</button>
    <button id="leaveBtn"   onclick="markLeave()">ğŸ–ï¸ Mark Leave</button>
    <button id="compOffBtn" onclick="markCompOff()">ğŸ Comp Off</button>
    <hr class="divider">
    <button id="logoutBtn"  onclick="logout()">Logout</button>
    <div id="statusMsg"></div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHPxa5jK4qw-b8e8kF_vh3I1yyslBhpjBo3AZCVtZKfKp8ktFJY3N3mRUsc1vM1_Ob/exec";

  let currentUser  = "";
  let currentName  = "";
  let cameraStream = null;
  let photoBase64  = "";

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(msg) { document.getElementById("statusMsg").textContent = msg; }
  function showInfo(msg)  { const b = document.getElementById("infoBox");  b.textContent = msg; b.style.display = msg ? "block" : "none"; }
  function showError(msg) { const b = document.getElementById("errorBox"); b.textContent = msg; b.style.display = msg ? "block" : "none"; }
  function setBtns(flag) {
    ["loginBtn","clockInBtn","clockOutBtn","snapBtn","weekOffBtn","leaveBtn","compOffBtn"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = flag;
    });
  }

  // â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPopup(icon, title, msg) {
    document.getElementById("popupIcon").textContent  = icon;
    document.getElementById("popupTitle").textContent = title;
    document.getElementById("popupMsg").textContent   = msg;
    document.getElementById("popupOverlay").classList.add("show");
  }
  function closePopup() {
    document.getElementById("popupOverlay").classList.remove("show");
  }

  // â”€â”€ API Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function callScript(action, data, callback) {
    const params = Object.assign({ action }, data);
    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(params),
      headers: { "Content-Type": "text/plain" }
    })
    .then(r => r.json())
    .then(callback)
    .catch(function(err) {
      setBtns(false);
      setStatus("âŒ Network error: " + err.message);
    });
  }

  // â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function login() {
    const loginId  = document.getElementById("loginId").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!loginId || !password) { setStatus("âš ï¸ Please enter Login ID and Password."); return; }
    setStatus("Logging inâ€¦"); setBtns(true);
    callScript("login", { loginId, password }, function(res) {
      setBtns(false);
      if (res.status) {
        currentUser = loginId; currentName = res.name;
        document.getElementById("loginDiv").style.display      = "none";
        document.getElementById("attendanceDiv").style.display = "block";
        document.getElementById("welcome").textContent = "Welcome, " + res.name + " ğŸ‘‹";
        setStatus(""); startCamera();
      } else {
        setStatus("âŒ " + (res.message || "Invalid Login."));
      }
    });
  }

  // â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startCamera() {
    showError(""); showInfo("Starting cameraâ€¦");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
    .then(function(stream) {
      cameraStream = stream;
      const video = document.getElementById("video");
      video.srcObject = stream; video.style.display = "block";
      video.onloadedmetadata = function() {
        video.play();
        showInfo("âœ… Camera ready â€” click Take Photo.");
      };
    })
    .catch(function(err) {
      showError("âŒ Camera error: " + err.message + " â€” Allow camera in browser settings.");
      showInfo("");
    });
  }
  function stopCamera() {
    if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  }

  // â”€â”€ Snap / Retake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function snapPhoto() {
    const video = document.getElementById("video");
    if (!video.videoWidth) { setStatus("âš ï¸ Camera not ready, please wait."); return; }
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    photoBase64 = canvas.toDataURL("image/jpeg", 0.7);
    document.getElementById("photoPreview").src           = photoBase64;
    document.getElementById("photoPreview").style.display = "block";
    document.getElementById("video").style.display        = "none";
    document.getElementById("snapBtn").style.display      = "none";
    document.getElementById("retakeBtn").style.display    = "block";
    showInfo("âœ… Photo captured! Now click Clock In or Clock Out.");
    setStatus("");
  }
  function retakePhoto() {
    photoBase64 = "";
    document.getElementById("photoPreview").style.display = "none";
    document.getElementById("photoPreview").src           = "";
    document.getElementById("video").style.display        = "block";
    document.getElementById("snapBtn").style.display      = "block";
    document.getElementById("retakeBtn").style.display    = "none";
    showInfo("âœ… Camera ready â€” click Take Photo.");
    setStatus("");
  }

  // â”€â”€ Geolocation â€” MANDATORY, blocks if no location â”€â”€â”€â”€â”€
  function getLocation(callback) {
    if (!navigator.geolocation) {
      setBtns(false);
      setStatus("âŒ Location not supported on this device/browser.");
      return;
    }
    setStatus("ğŸ“ Please allow location accessâ€¦");
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        callback(pos.coords.latitude, pos.coords.longitude);
      },
      function(err) {
        // BLOCK â€” do not proceed without location
        setBtns(false);
        setStatus("âŒ Location access denied. Please allow location and try again.");
        showPopup("ğŸ“", "Location Required!", "Please allow location access in your browser and try again.\n\nSteps:\n1. Click the ğŸ”’ lock icon in address bar\n2. Set Location â†’ Allow\n3. Refresh and try again");
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    );
  }

  // â”€â”€ Clock In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clockIn() {
    if (!photoBase64) { setStatus("âš ï¸ Please take a photo first."); return; }
    setStatus("ğŸ“ Getting locationâ€¦"); setBtns(true);
    getLocation(function(lat, lng) {
      setStatus("â³ Clocking Inâ€¦");
      callScript("clockIn", { loginId: currentUser, name: currentName, lat, lng, photo: photoBase64 }, function(res) {
        setBtns(false);
        const msg = res.message || "";
        if (msg.includes("Successful")) {
          setStatus("");
          showPopup("âœ…", "Clock In Successful!", "Your attendance has been recorded.\nTime: " + new Date().toLocaleTimeString());
          retakePhoto();
        } else {
          setStatus("âš ï¸ " + msg);
        }
      });
    });
  }

  // â”€â”€ Clock Out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clockOut() {
    if (!photoBase64) { setStatus("âš ï¸ Please take a photo first."); return; }
    setStatus("ğŸ“ Getting locationâ€¦"); setBtns(true);
    getLocation(function(lat, lng) {
      setStatus("â³ Clocking Outâ€¦");
      callScript("clockOut", { loginId: currentUser, lat, lng, photo: photoBase64 }, function(res) {
        setBtns(false);
        const msg = res.message || "";
        if (msg.includes("Successful")) {
          setStatus("");
          showPopup("ğŸ”´", "Clock Out Successful!", "Your departure has been recorded.\nTime: " + new Date().toLocaleTimeString());
          retakePhoto();
        } else {
          setStatus("âš ï¸ " + msg);
        }
      });
    });
  }

  // â”€â”€ Week Off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function markWeekOff() {
    if (!confirm("Mark today as Week Off for " + currentName + "?")) return;
    setBtns(true); setStatus("Marking Week Offâ€¦");
    callScript("weekOff", { loginId: currentUser, name: currentName }, function(res) {
      setBtns(false);
      const msg = res.message || "";
      if (msg.includes("Successful")) {
        setStatus("");
        showPopup("ğŸ“…", "Week Off Marked!", "Your week off has been recorded for today.");
      } else {
        setStatus("âš ï¸ " + msg);
      }
    });
  }

  // â”€â”€ Leave â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function markLeave() {
    if (!confirm("Mark today as Leave for " + currentName + "?")) return;
    setBtns(true); setStatus("Marking Leaveâ€¦");
    callScript("leave", { loginId: currentUser, name: currentName }, function(res) {
      setBtns(false);
      const msg = res.message || "";
      if (msg.includes("Successful")) {
        setStatus("");
        showPopup("ğŸ–ï¸", "Leave Marked!", "Your leave has been recorded for today.");
      } else {
        setStatus("âš ï¸ " + msg);
      }
    });
  }

  // â”€â”€ Comp Off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function markCompOff() {
    if (!confirm("Mark today as Comp Off for " + currentName + "?")) return;
    setBtns(true); setStatus("Marking Comp Offâ€¦");
    callScript("compOff", { loginId: currentUser, name: currentName }, function(res) {
      setBtns(false);
      const msg = res.message || "";
      if (msg.includes("Successful")) {
        setStatus("");
        showPopup("ğŸ", "Comp Off Marked!", "Your comp off has been recorded for today.");
      } else {
        setStatus("âš ï¸ " + msg);
      }
    });
  }

  // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function logout() {
    stopCamera(); retakePhoto();
    currentUser = currentName = "";
    document.getElementById("loginId").value  = "";
    document.getElementById("password").value = "";
    document.getElementById("attendanceDiv").style.display = "none";
    document.getElementById("loginDiv").style.display      = "block";
    showInfo(""); showError(""); setStatus("");
  }
</script>
</body>
</html>
